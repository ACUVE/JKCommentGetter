# ref http://www.mumudvb.net/sites/default/files/iso13818-1.pdf
# ref http://www.arib.or.jp/english/html/overview/doc/2-STD-B10v4_6.pdf
# ref http://jk.rutice.net/main.js

PACKET_SIZE = 188
SERVICE2JK = {}
DATA.each_line do |l|
	if m = l.match(/PACK_NTSID\(0x(.{4}).{4},\s*(\d+)\)/)
		SERVICE2JK[m[1].to_i(16)] = m[2].to_i
	end
end

File.open(ARGV.shift || exit(-1)) do |file|
	buff = file.read(1 * 1024 * 1024).unpack('C*')
	pos = 0
	pos += 1 while buff[pos] != 0x47
	
	while pos + PACKET_SIZE <= buff.size
		pkt = buff[pos, PACKET_SIZE]
		
		sync_byte = pkt[0];
		transport_error_indicator = (pkt[1] & 0b10000000) >> 7
		payload_unit_start_indicator = (pkt[1] & 0b1000000) >> 6
		pid = ((pkt[1] & 0b11111) << 8) | pkt[2]
		adaption_field_control = (pkt[3] & 0b110000) >> 4
		
		payload_start_pos = 4
		payload_start_pos += 1 + pkt[4] if adaption_field_control == 0b11 || adaption_field_control == 0b10
		
		case pid
		when 0x0
			# 1パケットに入りきっていると仮定
			if payload_unit_start_indicator == 0b1
				spos = payload_start_pos + 1 + pkt[payload_start_pos]
				seclength = ((pkt[spos + 1] & 0b1111) << 8) | pkt[spos + 2]
				((seclength - 9) / 4).times do |i|
					program_number = (pkt[spos + 8 + 4 * i] << 8) | pkt[spos + 9 + 4 * i]
					if SERVICE2JK[program_number]
						print SERVICE2JK[program_number]
						exit 0
					end
				end
				
				exit -1
			end
		end
		
		pos += PACKET_SIZE
	end
end
__END__
	PACK_NTSID(0x00650004, 101),
	PACK_NTSID(0x00660004, 101),
	PACK_NTSID(0x00670004, 103),
	PACK_NTSID(0x00680004, 103),
	PACK_NTSID(0x008D0004, 141),
	PACK_NTSID(0x008E0004, 141),
	PACK_NTSID(0x008F0004, 141),
	PACK_NTSID(0x00970004, 151),
	PACK_NTSID(0x00980004, 151),
	PACK_NTSID(0x00990004, 151),
	PACK_NTSID(0x00A10004, 161),
	PACK_NTSID(0x00A20004, 161),
	PACK_NTSID(0x00A30004, 161),
	PACK_NTSID(0x00AB0004, 171),
	PACK_NTSID(0x00AC0004, 171),
	PACK_NTSID(0x00AD0004, 171),
	PACK_NTSID(0x00B50004, 181),
	PACK_NTSID(0x00B60004, 181),
	PACK_NTSID(0x00B70004, 181),
	PACK_NTSID(0x00BF0004, 191),
	PACK_NTSID(0x00C00004, 192),
	PACK_NTSID(0x00C10004, 193),
	PACK_NTSID(0x00C80004, 200),
	PACK_NTSID(0x00C90004, 201),
	PACK_NTSID(0x00CA0004, 202),
	PACK_NTSID(0x00D30004, 211),
	PACK_NTSID(0x00DE0004, 222),
	PACK_NTSID(0x00E70004, 231),
	PACK_NTSID(0x00E80004, 231),
	PACK_NTSID(0x00E90004, 231),
	PACK_NTSID(0x00EA0004, 234),
	PACK_NTSID(0x00EC0004, 236),
	PACK_NTSID(0x00EE0004, 238),
	PACK_NTSID(0x00F10004, 241),
	PACK_NTSID(0x00F20004, 242),
	PACK_NTSID(0x00F30004, 243),
	PACK_NTSID(0x00F40004, 244),
	PACK_NTSID(0x00F50004, 245),
	PACK_NTSID(0x00FB0004, 251),
	PACK_NTSID(0x00FC0004, 252),
	PACK_NTSID(0x00FF0004, 255),
	PACK_NTSID(0x01000004, 256),
	PACK_NTSID(0x01020004, 258),
	PACK_NTSID(0x038E0004, 910),
	PACK_NTSID(0x0400000F,   1),
	PACK_NTSID(0x0408000F,   2),
	PACK_NTSID(0x0410000F,   4),
	PACK_NTSID(0x0418000F,   6),
	PACK_NTSID(0x0420000F,   8),
	PACK_NTSID(0x0428000F,   5),
	PACK_NTSID(0x0430000F,   7),
	PACK_NTSID(0x0440000F, 231),
	PACK_NTSID(0x0808000F,   2),
	PACK_NTSID(0x0810000F,   6),
	PACK_NTSID(0x0818000F,   5),
	PACK_NTSID(0x0820000F,   8),
	PACK_NTSID(0x0828000F,   4),
	PACK_NTSID(0x0C08000F,   2),
	PACK_NTSID(0x0C10000F,   8),
	PACK_NTSID(0x0C18000F,   6),
	PACK_NTSID(0x0C20000F,   5),
	PACK_NTSID(0x0C28000F,   4),
	PACK_NTSID(0x1010000F,   6),
	PACK_NTSID(0x1018000F,   4),
	PACK_NTSID(0x1020000F,   5),
	PACK_NTSID(0x1028000F,   8),
	PACK_NTSID(0x1030000F,   7),
	PACK_NTSID(0x1410000F,   4),
	PACK_NTSID(0x1418000F,   5),
	PACK_NTSID(0x1420000F,   6),
	PACK_NTSID(0x1428000F,   7),
	PACK_NTSID(0x1430000F,   8),
	PACK_NTSID(0x1810000F,   8),
	PACK_NTSID(0x1818000F,   6),
	PACK_NTSID(0x1820000F,   4),
	PACK_NTSID(0x2800000F,   1),
	PACK_NTSID(0x2808000F,   2),
	PACK_NTSID(0x2810000F,   6),
	PACK_NTSID(0x2818000F,   4),
	PACK_NTSID(0x2820000F,   5),
	PACK_NTSID(0x2828000F,   8),
	PACK_NTSID(0x2830000F,   7),
	PACK_NTSID(0x2C00000F,   1),
	PACK_NTSID(0x2C08000F,   2),
	PACK_NTSID(0x2C10000F,   6),
	PACK_NTSID(0x2C18000F,   4),
	PACK_NTSID(0x2C20000F,   5),
	PACK_NTSID(0x2C28000F,   8),
	PACK_NTSID(0x2C30000F,   7),
	PACK_NTSID(0x3000000F,   1),
	PACK_NTSID(0x3008000F,   2),
	PACK_NTSID(0x3010000F,   6),
	PACK_NTSID(0x3018000F,   4),
	PACK_NTSID(0x3020000F,   5),
	PACK_NTSID(0x3028000F,   8),
	PACK_NTSID(0x3030000F,   7),
	PACK_NTSID(0x3400000F,   1),
	PACK_NTSID(0x3408000F,   2),
	PACK_NTSID(0x3410000F,   6),
	PACK_NTSID(0x3418000F,   4),
	PACK_NTSID(0x3420000F,   5),
	PACK_NTSID(0x3428000F,   8),
	PACK_NTSID(0x3430000F,   7),
	PACK_NTSID(0x3800000F,   1),
	PACK_NTSID(0x3808000F,   2),
	PACK_NTSID(0x3810000F,   6),
	PACK_NTSID(0x3818000F,   4),
	PACK_NTSID(0x3820000F,   5),
	PACK_NTSID(0x3828000F,   8),
	PACK_NTSID(0x3830000F,   7),
	PACK_NTSID(0x3C00000F,   1),
	PACK_NTSID(0x3C08000F,   2),
	PACK_NTSID(0x3C10000F,   6),
	PACK_NTSID(0x3C18000F,   4),
	PACK_NTSID(0x3C20000F,   5),
	PACK_NTSID(0x3C28000F,   8),
	PACK_NTSID(0x3C30000F,   7),
	PACK_NTSID(0x4000000F,   1),
	PACK_NTSID(0x4008000F,   2),
	PACK_NTSID(0x4010000F,   6),
	PACK_NTSID(0x4018000F,   4),
	PACK_NTSID(0x4020000F,   5),
	PACK_NTSID(0x4028000F,   8),
	PACK_NTSID(0x4030000F,   7),
	PACK_NTSID(0x4400000F,   1),
	PACK_NTSID(0x4408000F,   2),
	PACK_NTSID(0x4410000F,   6),
	PACK_NTSID(0x4418000F,   8),
	PACK_NTSID(0x4420000F,   4),
	PACK_NTSID(0x4428000F,   5),
	PACK_NTSID(0x4800000F,   1),
	PACK_NTSID(0x4808000F,   2),
	PACK_NTSID(0x4810000F,   4),
	PACK_NTSID(0x4818000F,   8),
	PACK_NTSID(0x4820000F,   5),
	PACK_NTSID(0x4C00000F,   1),
	PACK_NTSID(0x4C08000F,   2),
	PACK_NTSID(0x4C10000F,   4),
	PACK_NTSID(0x4C18000F,   5),
	PACK_NTSID(0x4C20000F,   6),
	PACK_NTSID(0x4C28000F,   8),
	PACK_NTSID(0x5000000F,   1),
	PACK_NTSID(0x5008000F,   2),
	PACK_NTSID(0x5010000F,   6),
	PACK_NTSID(0x5018000F,   4),
	PACK_NTSID(0x5020000F,   8),
	PACK_NTSID(0x5028000F,   5),
	PACK_NTSID(0x5400000F,   1),
	PACK_NTSID(0x5408000F,   2),
	PACK_NTSID(0x5410000F,   8),
	PACK_NTSID(0x5418000F,   4),
	PACK_NTSID(0x5420000F,   5),
	PACK_NTSID(0x5428000F,   6),
	PACK_NTSID(0x5800000F,   1),
	PACK_NTSID(0x5808000F,   2),
	PACK_NTSID(0x5810000F,   4),
	PACK_NTSID(0x5818000F,   6),
	PACK_NTSID(0x5820000F,   5),
	PACK_NTSID(0x5C38000F,   9),
	PACK_NTSID(0x6038000F,  11),
	PACK_NTSID(0x6400000F,   1),
	PACK_NTSID(0x6800000F,   1),
	PACK_NTSID(0x6C38000F,  12),
	PACK_NTSID(0x7000000F,   1),
	PACK_NTSID(0x7438000F,  10),
	PACK_NTSID(0x7800000F,   1),
	PACK_NTSID(0x7808000F,   2),
	PACK_NTSID(0x7810000F,   4),
	PACK_NTSID(0x7818000F,   5),
	PACK_NTSID(0x7820000F,   6),
	PACK_NTSID(0x7828000F,   8),
	PACK_NTSID(0x7C00000F,   1),
	PACK_NTSID(0x7C08000F,   2),
	PACK_NTSID(0x7C10000F,   6),
	PACK_NTSID(0x7C18000F,   8),
	PACK_NTSID(0x7C20000F,   4),
	PACK_NTSID(0x7C28000F,   5),
	PACK_NTSID(0x8000000F,   1),
	PACK_NTSID(0x8008000F,   2),
	PACK_NTSID(0x8010000F,   4),
	PACK_NTSID(0x8018000F,   6),
	PACK_NTSID(0x8400000F,   1),
	PACK_NTSID(0x8430000F,   7),
	PACK_NTSID(0x8800000F,   1),
	PACK_NTSID(0x8808000F,   2),
	PACK_NTSID(0x8810000F,   4),
	PACK_NTSID(0x8818000F,   5),
	PACK_NTSID(0x8820000F,   6),
	PACK_NTSID(0x8828000F,   8),
	PACK_NTSID(0x8C00000F,   1),
	PACK_NTSID(0x8C08000F,   2),
	PACK_NTSID(0x8C10000F,   6),
	PACK_NTSID(0x8C18000F,   8),
	PACK_NTSID(0x8C20000F,   4),
	PACK_NTSID(0x8C28000F,   5),
	PACK_NTSID(0x9000000F,   1),
	PACK_NTSID(0x9008000F,   2),
	PACK_NTSID(0x9010000F,   4),
	PACK_NTSID(0x9018000F,   8),
	PACK_NTSID(0x9400000F,   1),
	PACK_NTSID(0x9408000F,   2),
	PACK_NTSID(0x9410000F,   4),
	PACK_NTSID(0x9418000F,   8),
	PACK_NTSID(0x9420000F,   6),
	PACK_NTSID(0x9800000F,   1),
	PACK_NTSID(0x9C00000F,   1),
	PACK_NTSID(0xA000000F,   1),
	PACK_NTSID(0xA030000F,   7),
	PACK_NTSID(0xA400000F,   1),
	PACK_NTSID(0xA800000F,   1),
	PACK_NTSID(0xAC00000F,   1),
	PACK_NTSID(0xB000000F,   1),
	PACK_NTSID(0xB400000F,   1),
	PACK_NTSID(0xB800000F,   1),
	PACK_NTSID(0xB808000F,   2),
	PACK_NTSID(0xB810000F,   6),
	PACK_NTSID(0xB818000F,   4),
	PACK_NTSID(0xB820000F,   5),
	PACK_NTSID(0xB828000F,   8),
	PACK_NTSID(0xBC00000F,   1),
	PACK_NTSID(0xBC08000F,   2),
	PACK_NTSID(0xC000000F,   1),
	PACK_NTSID(0xC008000F,   2),
	PACK_NTSID(0xC400000F,   1),
	PACK_NTSID(0xC408000F,   2),
	PACK_NTSID(0xC800000F,   1),
	PACK_NTSID(0xC808000F,   2),
	PACK_NTSID(0xC810000F,   4),
	PACK_NTSID(0xC818000F,   6),
	PACK_NTSID(0xC820000F,   5),
	PACK_NTSID(0xCC00000F,   1),
	PACK_NTSID(0xCC08000F,   2),
	PACK_NTSID(0xCC10000F,   4),
	PACK_NTSID(0xCC18000F,   5),
	PACK_NTSID(0xCC20000F,   6),
	PACK_NTSID(0xCC28000F,   8),
	PACK_NTSID(0xD000000F,   1),
	PACK_NTSID(0xD008000F,   2),
	PACK_NTSID(0xD400000F,   1),
	PACK_NTSID(0xD408000F,   2),
	PACK_NTSID(0xD410000F,   4),
	PACK_NTSID(0xD800000F,   1),
	PACK_NTSID(0xD808000F,   2),
	PACK_NTSID(0xD810000F,   4),
	PACK_NTSID(0xD818000F,   6),
	PACK_NTSID(0xD820000F,   8),
	PACK_NTSID(0xDC00000F,   1),
	PACK_NTSID(0xDC08000F,   2),
	PACK_NTSID(0xDC10000F,   5),
	PACK_NTSID(0xDC18000F,   6),
	PACK_NTSID(0xDC20000F,   4),
	PACK_NTSID(0xDC28000F,   7),
	PACK_NTSID(0xDC30000F,   8),
	PACK_NTSID(0xDE00000F,   1),
	PACK_NTSID(0xDE08000F,   2),
	PACK_NTSID(0xE000000F,   1),
	PACK_NTSID(0xE008000F,   2),
	PACK_NTSID(0xE010000F,   6),
	PACK_NTSID(0xE018000F,   8),
	PACK_NTSID(0xE020000F,   4),
	PACK_NTSID(0xE028000F,   5),
	PACK_NTSID(0xE400000F,   1),
	PACK_NTSID(0xE408000F,   2),
	PACK_NTSID(0xE410000F,   6),
	PACK_NTSID(0xE418000F,   8),
	PACK_NTSID(0xE420000F,   5),
	PACK_NTSID(0xE428000F,   4),
	PACK_NTSID(0xE800000F,   1),
	PACK_NTSID(0xE808000F,   2),
	PACK_NTSID(0xE810000F,   6),
	PACK_NTSID(0xE818000F,   8),
	PACK_NTSID(0xE820000F,   5),
	PACK_NTSID(0xE828000F,   4),
	PACK_NTSID(0xEC00000F,   1),
	PACK_NTSID(0xEC08000F,   2),
	PACK_NTSID(0xEC10000F,   6),
	PACK_NTSID(0xEC18000F,   8),
	PACK_NTSID(0xF000000F,   1),
	PACK_NTSID(0xF008000F,   2),
	PACK_NTSID(0xF010000F,   6),
	PACK_NTSID(0xF018000F,   4),
	PACK_NTSID(0xF020000F,   5),
	PACK_NTSID(0xF400000F,   1),
	PACK_NTSID(0xF408000F,   2),
	PACK_NTSID(0xF410000F,   8),
	PACK_NTSID(0xF800000F,   1),
	PACK_NTSID(0xF808000F,   2),
	PACK_NTSID(0xF810000F,   6),
	PACK_NTSID(0xF820000F,   5),
	PACK_NTSID(0xF838000F,   8),
